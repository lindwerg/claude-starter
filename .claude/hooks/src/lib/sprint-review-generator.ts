/**
 * Sprint Review Generator - –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç—á—ë—Ç–∞ –æ —Å–ø—Ä–∏–Ω—Ç–µ
 *
 * –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç:
 * - Task queue (–∑–∞–¥–∞—á–∏, stories)
 * - Git commits
 * - Learnings –∏–∑ scratchpad.md
 */

import * as fs from 'fs/promises';
import { exec } from 'child_process';
import { promisify } from 'util';
import type { TaskQueue, Story } from './task-queue-types';
import { groupTasksByStory, getCommitsFromTasks, calculateTotalDuration } from './task-queue-types';

const execAsync = promisify(exec);

// ============================================================================
// Generate Sprint Review
// ============================================================================

/**
 * –ì–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å Sprint Review markdown –æ—Ç—á—ë—Ç
 */
export async function generateSprintReview(queue: TaskQueue): Promise<string> {
  console.log('\nüìù Generating Sprint Review...\n');

  const stories = groupTasksByStory(queue.tasks);
  const completedStories = stories.filter(s => s.completed_tasks === s.total_tasks);
  const commits = getCommitsFromTasks(queue.tasks);
  const totalDuration = calculateTotalDuration(queue.tasks);

  // –ß–∏—Ç–∞–µ–º learnings –∏–∑ scratchpad
  const learnings = await readLearningsFromScratchpad();

  // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º markdown
  const review = `# Sprint ${queue.sprint} Review

**Completed:** ${new Date().toISOString()}

## Summary

- **Sprint:** ${queue.sprint}
- **Stories:** ${completedStories.length}/${stories.length} completed
- **Tasks:** ${queue.summary.completed_tasks}/${queue.summary.total_tasks} done
- **Commits:** ${commits.length}
- **Duration:** ${Math.round(totalDuration / 60)} hours

## Stories Delivered

${renderStories(stories)}

## Git Commits

${commits.length > 0 ? renderCommits(commits) : '_No commits recorded_'}

## Blockers & Learnings

${learnings.length > 0 ? learnings.join('\n') : '_No learnings recorded_'}

---

_Generated by Ralph Loop Sprint Automation_
`;

  return review;
}

// ============================================================================
// Helpers
// ============================================================================

/**
 * –†–µ–Ω–¥–µ—Ä stories –≤ markdown
 */
function renderStories(stories: Story[]): string {
  return stories.map(story => {
    const status = story.completed_tasks === story.total_tasks ? '‚úÖ' : '‚è≥';
    const tasks = story.tasks.map(task => {
      const taskStatus = task.status === 'done' ? '‚úÖ' : '‚è≥';
      return `  - ${taskStatus} ${task.id}: ${task.title}`;
    }).join('\n');

    return `### ${status} ${story.story_id} (${story.completed_tasks}/${story.total_tasks} tasks)

${tasks}
`;
  }).join('\n');
}

/**
 * –†–µ–Ω–¥–µ—Ä commits –≤ markdown
 */
function renderCommits(commits: string[]): string {
  return commits.map(hash => `- \`${hash}\``).join('\n');
}

/**
 * –ß–∏—Ç–∞—Ç—å learnings –∏–∑ .bmad/scratchpad.md
 */
async function readLearningsFromScratchpad(): Promise<string[]> {
  try {
    const content = await fs.readFile('.bmad/scratchpad.md', 'utf-8');

    // –ü–∞—Ä—Å–∏–º —Å–µ–∫—Ü–∏—é "learnings:"
    const learningsMatch = content.match(/learnings:\s*\n((?:  - .+\n?)+)/);
    if (learningsMatch) {
      const learningsText = learningsMatch[1];
      return learningsText.split('\n')
        .filter(line => line.trim().startsWith('- '))
        .map(line => line.trim());
    }

    return [];
  } catch (error) {
    return [];
  }
}
